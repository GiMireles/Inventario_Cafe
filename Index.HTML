<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventario de CafÃ©</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4 text-center">Inventario de CafÃ©</h1>
    <ul class="nav nav-tabs mb-3" id="tabMenu">
      <li class="nav-item"><a class="nav-link active" data-target="sectionAdd">Alta Producto</a></li>
      <li class="nav-item"><a class="nav-link" data-target="sectionSale">Registro Venta</a></li>
      <li class="nav-item"><a class="nav-link" data-target="sectionDash">Dashboard</a></li>
    </ul>

    <div class="tab-content">
      <!-- Alta Producto -->
      <div id="sectionAdd" class="tab-pane fade show active">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Alta de Producto</h5>
            <form id="formAdd">
              <div class="mb-3">
                <label for="calidad" class="form-label">Calidad</label>
                <select id="calidad" class="form-select">
                  <option value="">Seleccione</option>
                  <option>Desmanche</option>
                  <option>PL20</option>
                  <option>Americana</option>
                  <option>Europea</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="tueste" class="form-label">Tueste</label>
                <select id="tueste" class="form-select">
                  <option value="">Seleccione</option>
                  <option>ClÃ¡sico</option>
                  <option>Acadian</option>
                  <option>Medio</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="molido" class="form-label">Molido</label>
                <select id="molido" class="form-select">
                  <option value="">Seleccione</option>
                  <option>En grano</option>
                  <option>Molido</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="stock" class="form-label">Stock Inicial (kg)</label>
                <input type="number" id="stock" class="form-control" step="0.01" min="0">
              </div>
              <div class="mb-3">
                <label for="umbral" class="form-label">Umbral Alerta (kg)</label>
                <input type="number" id="umbral" class="form-control" step="0.01" min="0">
              </div>
              <button type="submit" class="btn btn-primary">Guardar Producto</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Registro Venta -->
      <div id="sectionSale" class="tab-pane fade">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Registro de Venta</h5>
            <form id="formSale">
              <div class="mb-3">
                <label for="prodSale" class="form-label">Producto</label>
                <select id="prodSale" class="form-select">
                  <option value="">Seleccione</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="qtySale" class="form-label">Cantidad vendida (kg)</label>
                <input type="number" id="qtySale" class="form-control" step="0.01" min="0">
              </div>
              <button type="submit" class="btn btn-success">Registrar Venta</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Dashboard -->
      <div id="sectionDash" class="tab-pane fade">
        <div class="alert alert-danger d-none" id="lowStockAlert">
          ðŸ”” Hay productos que requieren reposiciÃ³n. Â¡Revisa el stock bajo!
        </div>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Resumen de Ventas</h5>
            <p id="salesSummary">Cargando resumen...</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Dashboard de Inventario</h5>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Producto</th>
                  <th>Stock (kg)</th>
                  <th>Umbral (kg)</th>
                  <th>Vendidos (kg)</th>
                </tr>
              </thead>
              <tbody id="inventoryTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let products = [];
    let sales = [];
    let nextProductId = 1;

    function saveToStorage() {
      localStorage.setItem('products', JSON.stringify(products));
      localStorage.setItem('sales', JSON.stringify(sales));
      localStorage.setItem('nextProductId', nextProductId);
    }

    function loadFromStorage() {
      const p = localStorage.getItem('products');
      const s = localStorage.getItem('sales');
      const n = localStorage.getItem('nextProductId');
      products = p ? JSON.parse(p) : [];
      sales = s ? JSON.parse(s) : [];
      if (n !== null) nextProductId = parseInt(n);
    }

    document.querySelectorAll('#tabMenu .nav-link').forEach(link => {
      link.addEventListener('click', function() {
        document.querySelectorAll('#tabMenu .nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show','active'));
        document.getElementById(this.dataset.target).classList.add('show','active');
        if (this.dataset.target === 'sectionSale') loadProductsForSale();
        if (this.dataset.target === 'sectionDash') {
          refreshDashboard();
          updateSalesSummary();
        }
      });
    });

    document.getElementById('formAdd').addEventListener('submit', function(e) {
      e.preventDefault();
      const calidad = document.getElementById('calidad').value;
      const tueste = document.getElementById('tueste').value;
      const molido = document.getElementById('molido').value;
      const stock  = parseFloat(document.getElementById('stock').value);
      const umbral = parseFloat(document.getElementById('umbral').value);
      if (!calidad || !tueste || !molido || isNaN(stock) || isNaN(umbral)) {
        alert('Complete todos los campos.'); return;
      }
      products.push({ id: nextProductId++, calidad, tueste, molido, stock, umbral });
      saveToStorage();
      alert('Producto registrado correctamente.');
      this.reset();
    });

    function loadProductsForSale() {
      const sel = document.getElementById('prodSale'); sel.innerHTML = '<option value="">Seleccione</option>';
      products.forEach(p => {
        const o = document.createElement('option'); o.value = p.id;
        o.text = `${p.calidad} - ${p.tueste} - ${p.molido}`;
        sel.add(o);
      });
    }

    document.getElementById('formSale').addEventListener('submit', function(e) {
      e.preventDefault();
      const prodId = parseInt(document.getElementById('prodSale').value);
      const qty    = parseFloat(document.getElementById('qtySale').value);
      if (isNaN(prodId) || isNaN(qty) || qty <= 0) { alert('Selecciona un producto y cantidad vÃ¡lida.'); return; }
      const prod = products.find(p => p.id === prodId);
      prod.stock -= qty;
      sales.push({ productId: prodId, qty, date: new Date().toISOString() });
      saveToStorage();
      this.reset();
      document.querySelector('[data-target="sectionDash"]').click();
    });

    function refreshDashboard() {
      const tbody = document.getElementById('inventoryTable');
      const alertBox = document.getElementById('lowStockAlert');
      tbody.innerHTML = ''; let lowExists = false;
      products.forEach(p => {
        const soldQty = sales
          .filter(s => s.productId === p.id)
          .reduce((sum, s) => sum + s.qty, 0);
        const tr = document.createElement('tr');
        const lowClass = p.stock <= p.umbral ? 'text-danger fw-bold' : '';
        if (p.stock <= p.umbral) lowExists = true;
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.calidad} - ${p.tueste} - ${p.molido}</td>
          <td class="${lowClass}">${p.stock.toFixed(2)}</td>
          <td>${p.umbral.toFixed(2)}</td>
          <td>${soldQty.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
      alertBox.classList.toggle('d-none', !lowExists);
    }

    function updateSalesSummary() {
      const salesCount = sales.length;
      const totalQty = sales.reduce((acc, s) => acc + s.qty, 0);
      document.getElementById('salesSummary').textContent = `Ventas registradas: ${salesCount} transacciones â€¢ ${totalQty.toFixed(2)} kg vendidos`;
    }

    loadFromStorage();
  </script>
</body>
</html>
